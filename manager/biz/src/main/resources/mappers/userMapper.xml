<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.alibaba.otter.manager.biz.user.mapper.UserMapper">

    <resultMap id="userResult" type="com.alibaba.otter.manager.biz.user.dal.dataobject.UserDO">
        <result property="id" column="ID"/>
        <result property="name" column="USERNAME"/>
        <result property="password" column="PASSWORD"/>
        <result property="department" column="DEPARTMENT"/>
        <result property="realName" column="REALNAME"/>
        <result property="authorizeType" column="AUTHORIZETYPE" typeHandler=""/>
        <result property="gmtCreate" column="GMT_CREATE"/>
        <result property="gmtModified" column="GMT_MODIFIED"/>
    </resultMap>

    <!-- all user columns -->
    <sql id="allUserColumns">ID,USERNAME,PASSWORD,DEPARTMENT,REALNAME,AUTHORIZETYPE,GMT_CREATE,GMT_MODIFIED</sql>

    <!-- getUserById -->
    <select id="findUserById" resultMap="userResult">
        select
        <include refid="allUserColumns"/>
        from USER where ID = #{value}
    </select>


    <select id="getCount">
        select count(*) from USER
        <dynamic prepend="where">
            <isNotEmpty property="searchKey">
                USERNAME like concat('%',replace(#searchKey#,'_','\_'),'%')
                or ID like concat('%',replace(#searchKey#,'_','\_'),'%')
                or DEPARTMENT like concat('%',replace(#searchKey#,'_','\_'),'%')
                or REALNAME like concat('%',replace(#searchKey#,'_','\_'),'%')
            </isNotEmpty>
        </dynamic>
    </select>

    <!-- listUsers -->
    <select id="listAllUsers" resultMap="userResult">
        select
        <include refid="allUserColumns"/>
        from USER
        <dynamic prepend="where">
            <isNotEmpty property="searchKey">
                USERNAME like concat('%',replace(#searchKey#,'_','\_'),'%')
                or ID like concat('%',replace(#searchKey#,'_','\_'),'%')
                or DEPARTMENT like concat('%',replace(#searchKey#,'_','\_'),'%')
                or REALNAME like concat('%',replace(#searchKey#,'_','\_'),'%')
            </isNotEmpty>
        </dynamic>

        ORDER BY ID DESC

        <dynamic>
            <isNotEmpty property="offset">
                <isNotEmpty property="length">
                    limit #offset#, #length#
                </isNotEmpty>
            </isNotEmpty>
        </dynamic>
    </select>

    <update id="updateUser">
        update USER
        set
        <dynamic>
            <isNotEmpty property="name">
                USERNAME=#name#,
            </isNotEmpty>
            <isNotEmpty property="password">
                PASSWORD=#password#,
            </isNotEmpty>
        </dynamic>
        DEPARTMENT=#department#,
        REALNAME=#realName#,
        AUTHORIZETYPE=#authorizeType#,
        GMT_MODIFIED=now()
        WHERE ID = #id#
    </update>

    <select id="chackUnique">
        select count(*)
        from USER
        where USER.ID != #{user.id}#
          and USER.USERNAME = #{user.name}
    </select>

    <!--
      - ===============================================
      - 验证name、password
      - ===============================================
     -->
    <select id="getUserByNameAndPassword" resultMap="userResult" parameterClass="user">
        select
        <include refid="allUserColumns"/>
        from
        USER
        where
        USERNAME = #name#
        and PASSWORD = #password#
    </select>


    <insert id="insertUser">
        insert into USER
        (USERNAME, PASSWORD,DEPARTMENT,REALNAME,AUTHORIZETYPE, GMT_CREATE, GMT_MODIFIED)
        SELECT #name#,#password#,#department#,#realName#,#authorizeType#,now(),now()
        from dual
        WHERE not exists (select * from USER
        where USER.USERNAME = #name#);
        <selectKey keyProperty="id" id="id">
            select last_insert_id()
        </selectKey>
    </insert>


    <delete id="deleteUser"><![CDATA[
        delete
        from USER
        where ID = #{value}
        ]]></delete>

</mapper>
